{"version":3,"sources":["@wordpress/block-editor/src/components/image-editor/use-save-image.js"],"names":["apiFetch","useDispatch","useCallback","useMemo","useState","__","sprintf","store","noticesStore","__unstableStripHTML","stripHTML","useSaveImage","crop","rotation","height","width","aspect","url","id","onSaveImage","onFinishEditing","createErrorNotice","isInProgress","setIsInProgress","cancel","apply","modifiers","push","type","args","angle","left","x","top","y","path","method","data","src","then","response","source_url","catch","error","message","finally"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\n// Disable Reason: Needs to be refactored.\n// eslint-disable-next-line no-restricted-imports\nimport apiFetch from '@wordpress/api-fetch';\nimport { useDispatch } from '@wordpress/data';\nimport { useCallback, useMemo, useState } from '@wordpress/element';\nimport { __, sprintf } from '@wordpress/i18n';\nimport { store as noticesStore } from '@wordpress/notices';\nimport { __unstableStripHTML as stripHTML } from '@wordpress/dom';\n\nexport default function useSaveImage( {\n\tcrop,\n\trotation,\n\theight,\n\twidth,\n\taspect,\n\turl,\n\tid,\n\tonSaveImage,\n\tonFinishEditing,\n} ) {\n\tconst { createErrorNotice } = useDispatch( noticesStore );\n\tconst [ isInProgress, setIsInProgress ] = useState( false );\n\n\tconst cancel = useCallback( () => {\n\t\tsetIsInProgress( false );\n\t\tonFinishEditing();\n\t}, [ setIsInProgress, onFinishEditing ] );\n\n\tconst apply = useCallback( () => {\n\t\tsetIsInProgress( true );\n\n\t\tconst modifiers = [];\n\n\t\tif ( rotation > 0 ) {\n\t\t\tmodifiers.push( {\n\t\t\t\ttype: 'rotate',\n\t\t\t\targs: {\n\t\t\t\t\tangle: rotation,\n\t\t\t\t},\n\t\t\t} );\n\t\t}\n\n\t\t// The crop script may return some very small, sub-pixel values when the image was not cropped.\n\t\t// Crop only when the new size has changed by more than 0.1%.\n\t\tif ( crop.width < 99.9 || crop.height < 99.9 ) {\n\t\t\tmodifiers.push( {\n\t\t\t\ttype: 'crop',\n\t\t\t\targs: {\n\t\t\t\t\tleft: crop.x,\n\t\t\t\t\ttop: crop.y,\n\t\t\t\t\twidth: crop.width,\n\t\t\t\t\theight: crop.height,\n\t\t\t\t},\n\t\t\t} );\n\t\t}\n\n\t\tapiFetch( {\n\t\t\tpath: `/wp/v2/media/${ id }/edit`,\n\t\t\tmethod: 'POST',\n\t\t\tdata: { src: url, modifiers },\n\t\t} )\n\t\t\t.then( ( response ) => {\n\t\t\t\tonSaveImage( {\n\t\t\t\t\tid: response.id,\n\t\t\t\t\turl: response.source_url,\n\t\t\t\t} );\n\t\t\t} )\n\t\t\t.catch( ( error ) => {\n\t\t\t\tcreateErrorNotice(\n\t\t\t\t\tsprintf(\n\t\t\t\t\t\t/* translators: 1. Error message */\n\t\t\t\t\t\t__( 'Could not edit image. %s' ),\n\t\t\t\t\t\tstripHTML( error.message )\n\t\t\t\t\t),\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'image-editing-error',\n\t\t\t\t\t\ttype: 'snackbar',\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t} )\n\t\t\t.finally( () => {\n\t\t\t\tsetIsInProgress( false );\n\t\t\t\tonFinishEditing();\n\t\t\t} );\n\t}, [\n\t\tsetIsInProgress,\n\t\tcrop,\n\t\trotation,\n\t\theight,\n\t\twidth,\n\t\taspect,\n\t\turl,\n\t\tonSaveImage,\n\t\tcreateErrorNotice,\n\t\tsetIsInProgress,\n\t\tonFinishEditing,\n\t] );\n\n\treturn useMemo(\n\t\t() => ( {\n\t\t\tisInProgress,\n\t\t\tapply,\n\t\t\tcancel,\n\t\t} ),\n\t\t[ isInProgress, apply, cancel ]\n\t);\n}\n"]}