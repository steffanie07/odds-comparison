{"version":3,"sources":["@wordpress/block-editor/src/components/writing-flow/use-tab-nav.js"],"names":["useTabNav","container","focusCaptureBeforeRef","focusCaptureAfterRef","lastFocus","hasMultiSelection","getSelectedBlockClientId","getBlockCount","blockEditorStore","setNavigationMode","isNavigationMode","select","focusCaptureTabIndex","undefined","noCapture","onFocusCapture","event","current","focus","canvasElement","ownerDocument","target","defaultView","frameElement","isBefore","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","tabbables","tabbable","find","length","next","before","after","ref","node","onKeyDown","defaultPrevented","keyCode","ESCAPE","preventDefault","TAB","isShift","shiftKey","direction","nextTabbable","currentBlock","closest","isElementPartOfSelectedBlock","preventScroll","onFocusOut","relatedTarget","activeElement","body","preventScrollOnTab","getAttribute","addEventListener","removeEventListener","mergedRefs"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { focus, isFormElement } from '@wordpress/dom';\nimport { TAB, ESCAPE } from '@wordpress/keycodes';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { useRefEffect, useMergeRefs } from '@wordpress/compose';\nimport { useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { store as blockEditorStore } from '../../store';\nimport { isInSameBlock, isInsideRootBlock } from '../../utils/dom';\n\nexport default function useTabNav() {\n\tconst container = useRef();\n\tconst focusCaptureBeforeRef = useRef();\n\tconst focusCaptureAfterRef = useRef();\n\tconst lastFocus = useRef();\n\tconst { hasMultiSelection, getSelectedBlockClientId, getBlockCount } =\n\t\tuseSelect( blockEditorStore );\n\tconst { setNavigationMode } = useDispatch( blockEditorStore );\n\tconst isNavigationMode = useSelect(\n\t\t( select ) => select( blockEditorStore ).isNavigationMode(),\n\t\t[]\n\t);\n\n\t// Don't allow tabbing to this element in Navigation mode.\n\tconst focusCaptureTabIndex = ! isNavigationMode ? '0' : undefined;\n\n\t// Reference that holds the a flag for enabling or disabling\n\t// capturing on the focus capture elements.\n\tconst noCapture = useRef();\n\n\tfunction onFocusCapture( event ) {\n\t\t// Do not capture incoming focus if set by us in WritingFlow.\n\t\tif ( noCapture.current ) {\n\t\t\tnoCapture.current = null;\n\t\t} else if ( hasMultiSelection() ) {\n\t\t\tcontainer.current.focus();\n\t\t} else if ( getSelectedBlockClientId() ) {\n\t\t\tlastFocus.current.focus();\n\t\t} else {\n\t\t\tsetNavigationMode( true );\n\n\t\t\tconst canvasElement =\n\t\t\t\tcontainer.current.ownerDocument === event.target.ownerDocument\n\t\t\t\t\t? container.current\n\t\t\t\t\t: container.current.ownerDocument.defaultView.frameElement;\n\n\t\t\tconst isBefore =\n\t\t\t\t// eslint-disable-next-line no-bitwise\n\t\t\t\tevent.target.compareDocumentPosition( canvasElement ) &\n\t\t\t\tevent.target.DOCUMENT_POSITION_FOLLOWING;\n\t\t\tconst tabbables = focus.tabbable.find( container.current );\n\n\t\t\tif ( tabbables.length ) {\n\t\t\t\tconst next = isBefore\n\t\t\t\t\t? tabbables[ 0 ]\n\t\t\t\t\t: tabbables[ tabbables.length - 1 ];\n\n\t\t\t\tnext.focus();\n\t\t\t}\n\t\t}\n\t}\n\n\tconst before = (\n\t\t<div\n\t\t\tref={ focusCaptureBeforeRef }\n\t\t\ttabIndex={ focusCaptureTabIndex }\n\t\t\tonFocus={ onFocusCapture }\n\t\t/>\n\t);\n\n\tconst after = (\n\t\t<div\n\t\t\tref={ focusCaptureAfterRef }\n\t\t\ttabIndex={ focusCaptureTabIndex }\n\t\t\tonFocus={ onFocusCapture }\n\t\t/>\n\t);\n\n\tconst ref = useRefEffect( ( node ) => {\n\t\tfunction onKeyDown( event ) {\n\t\t\tif ( event.defaultPrevented ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( event.keyCode === ESCAPE && ! hasMultiSelection() ) {\n\t\t\t\tevent.preventDefault();\n\t\t\t\tsetNavigationMode( true );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// In Edit mode, Tab should focus the first tabbable element after\n\t\t\t// the content, which is normally the sidebar (with block controls)\n\t\t\t// and Shift+Tab should focus the first tabbable element before the\n\t\t\t// content, which is normally the block toolbar.\n\t\t\t// Arrow keys can be used, and Tab and arrow keys can be used in\n\t\t\t// Navigation mode (press Esc), to navigate through blocks.\n\t\t\tif ( event.keyCode !== TAB ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst isShift = event.shiftKey;\n\t\t\tconst direction = isShift ? 'findPrevious' : 'findNext';\n\n\t\t\tif ( ! hasMultiSelection() && ! getSelectedBlockClientId() ) {\n\t\t\t\t// Preserve the behaviour of entering navigation mode when\n\t\t\t\t// tabbing into the content without a block selection.\n\t\t\t\t// `onFocusCapture` already did this previously, but we need to\n\t\t\t\t// do it again here because after clearing block selection,\n\t\t\t\t// focus land on the writing flow container and pressing Tab\n\t\t\t\t// will no longer send focus through the focus capture element.\n\t\t\t\tif ( event.target === node ) setNavigationMode( true );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst nextTabbable = focus.tabbable[ direction ]( event.target );\n\n\t\t\t// We want to constrain the tabbing to the block and its child blocks.\n\t\t\t// If the preceding form element is within a different block,\n\t\t\t// such as two sibling image blocks in the placeholder state,\n\t\t\t// we want shift + tab from the first form element to move to the image\n\t\t\t// block toolbar and not the previous image block's form element.\n\t\t\tconst currentBlock = event.target.closest( '[data-block]' );\n\t\t\tconst isElementPartOfSelectedBlock =\n\t\t\t\tcurrentBlock &&\n\t\t\t\tnextTabbable &&\n\t\t\t\t( isInSameBlock( currentBlock, nextTabbable ) ||\n\t\t\t\t\tisInsideRootBlock( currentBlock, nextTabbable ) );\n\n\t\t\t// Allow tabbing from the block wrapper to a form element,\n\t\t\t// and between form elements rendered in a block and its child blocks,\n\t\t\t// such as inside a placeholder. Form elements are generally\n\t\t\t// meant to be UI rather than part of the content. Ideally\n\t\t\t// these are not rendered in the content and perhaps in the\n\t\t\t// future they can be rendered in an iframe or shadow DOM.\n\t\t\tif (\n\t\t\t\tisFormElement( nextTabbable ) &&\n\t\t\t\tisElementPartOfSelectedBlock\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst next = isShift ? focusCaptureBeforeRef : focusCaptureAfterRef;\n\n\t\t\t// Disable focus capturing on the focus capture element, so it\n\t\t\t// doesn't refocus this block and so it allows default behaviour\n\t\t\t// (moving focus to the next tabbable element).\n\t\t\tnoCapture.current = true;\n\n\t\t\t// Focusing the focus capture element, which is located above and\n\t\t\t// below the editor, should not scroll the page all the way up or\n\t\t\t// down.\n\t\t\tnext.current.focus( { preventScroll: true } );\n\t\t}\n\n\t\tfunction onFocusOut( event ) {\n\t\t\tlastFocus.current = event.target;\n\n\t\t\tconst { ownerDocument } = node;\n\n\t\t\t// If focus disappears due to there being no blocks, move focus to\n\t\t\t// the writing flow wrapper.\n\t\t\tif (\n\t\t\t\t! event.relatedTarget &&\n\t\t\t\townerDocument.activeElement === ownerDocument.body &&\n\t\t\t\tgetBlockCount() === 0\n\t\t\t) {\n\t\t\t\tnode.focus();\n\t\t\t}\n\t\t}\n\n\t\t// When tabbing back to an element in block list, this event handler prevents scrolling if the\n\t\t// focus capture divs (before/after) are outside of the viewport. (For example shift+tab back to a paragraph\n\t\t// when focus is on a sidebar element. This prevents the scrollable writing area from jumping either to the\n\t\t// top or bottom of the document.\n\t\t//\n\t\t// Note that it isn't possible to disable scrolling in the onFocus event. We need to intercept this\n\t\t// earlier in the keypress handler, and call focus( { preventScroll: true } ) instead.\n\t\t// https://developer.mozilla.org/en-US/docs/Web/API/HTMLOrForeignElement/focus#parameters\n\t\tfunction preventScrollOnTab( event ) {\n\t\t\tif ( event.keyCode !== TAB ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( event.target?.getAttribute( 'role' ) === 'region' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( container.current === event.target ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst isShift = event.shiftKey;\n\t\t\tconst direction = isShift ? 'findPrevious' : 'findNext';\n\t\t\tconst target = focus.tabbable[ direction ]( event.target );\n\t\t\t// Only do something when the next tabbable is a focus capture div (before/after)\n\t\t\tif (\n\t\t\t\ttarget === focusCaptureBeforeRef.current ||\n\t\t\t\ttarget === focusCaptureAfterRef.current\n\t\t\t) {\n\t\t\t\tevent.preventDefault();\n\t\t\t\ttarget.focus( { preventScroll: true } );\n\t\t\t}\n\t\t}\n\n\t\tconst { ownerDocument } = node;\n\t\tconst { defaultView } = ownerDocument;\n\t\tdefaultView.addEventListener( 'keydown', preventScrollOnTab );\n\t\tnode.addEventListener( 'keydown', onKeyDown );\n\t\tnode.addEventListener( 'focusout', onFocusOut );\n\t\treturn () => {\n\t\t\tdefaultView.removeEventListener( 'keydown', preventScrollOnTab );\n\t\t\tnode.removeEventListener( 'keydown', onKeyDown );\n\t\t\tnode.removeEventListener( 'focusout', onFocusOut );\n\t\t};\n\t}, [] );\n\n\tconst mergedRefs = useMergeRefs( [ container, ref ] );\n\n\treturn [ before, mergedRefs, after ];\n}\n"]}